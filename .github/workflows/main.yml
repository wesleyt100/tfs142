name: Build Windows (Ninja VCPKG)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "src/**"
      - "CMakeLists.txt"
      - "CMakePresets.json"
      - "vcpkg.json"
      - ".github/workflows/build-windows-ninja.yml"

jobs:
  build:
    name: Build Release (Ninja)
    runs-on: windows-2022

    # Variáveis de ambiente
    env:
      VCPKG_DEFAULT_TRIPLET: x64-windows
      VCPKG_CXX_FLAGS: "/arch:SSE2"
      VCPKG_C_FLAGS: "/arch:SSE2"

    steps:
      - name: Checkout do Código
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Instalar CMake e Ninja
        uses: lukka/get-cmake@latest

      - name: Clonar vcpkg manualmente
        run: |
          git clone https://github.com/microsoft/vcpkg.git vcpkg
          cd vcpkg
          # Substitua pelo seu builtin-baseline do vcpkg.json
          git checkout a42c6c9e9d9a6e1f3c7d1f5f5b7c4e7d9a6e2c4b

      - name: Configurar VCPKG
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgJsonGlob: 'vcpkg.json'

      - name: Compilar com CMake Presets
        uses: lukka/run-cmake@v10
        with:
          configurePreset: 'ninja-vcpkg'
          buildPreset: 'ninja-vcpkg'
          configurePresetAdditionalArgs: -DCMAKE_BUILD_TYPE=Release

      - name: Preparar Artefatos (EXE + DLLs)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "artifacts"
          
          $buildDir = "build"
          Write-Host "--- Procurando tfs.exe ---"
          $exe = Get-ChildItem -Path $buildDir -Filter "tfs.exe" -Recurse | Select-Object -First 1
          
          if ($exe) {
            Write-Host "Executável encontrado: $($exe.FullName)"
            Copy-Item $exe.FullName -Destination "artifacts/"
          } else {
            Write-Error "ERRO CRÍTICO: tfs.exe não encontrado na pasta $buildDir!"
            exit 1
          }

          Write-Host "--- Copiando DLLs necessárias ---"
          $dlls = Get-ChildItem -Path $buildDir -Filter "*.dll" -Recurse
          
          foreach ($dll in $dlls) {
            if ($dll.DirectoryName -notmatch "CMakeFiles" -and $dll.DirectoryName -notmatch "test") {
               Write-Host "Copiando: $($dll.Name)"
               Copy-Item $dll.FullName -Destination "artifacts/" -Force
            }
          }

          if (Test-Path "config.lua") { Copy-Item "config.lua" -Destination "artifacts/" }

      - name: Upload do Download
        uses: actions/upload-artifact@v4
        with:
          name: tfs-windows-ninja
          path: artifacts/*
