name: Build Windows (Ninja VCPKG)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "src/**"
      - "CMakeLists.txt"
      - "CMakePresets.json"
      - "vcpkg.json"
      - ".github/workflows/build-windows-ninja.yml"

jobs:
  build:
    name: Build Release (Ninja)
    runs-on: windows-2022

    env:
      # Triplet para bibliotecas Windows
      VCPKG_DEFAULT_TRIPLET: x64-windows
      # Força compatibilidade SSE2
      VCPKG_CXX_FLAGS: "/arch:SSE2"
      VCPKG_C_FLAGS: "/arch:SSE2"

    steps:
      - name: Checkout do Código
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Instalar CMake e Ninja
        uses: lukka/get-cmake@latest

      - name: Instalar vcpkg baseado no builtin-baseline
        run: |
          echo "Buscando SHA do builtin-baseline no vcpkg.json..."
          $baseline = (Get-Content vcpkg.json | ConvertFrom-Json)."builtin-baseline"
          if (-not $baseline) {
            Write-Error "builtin-baseline não encontrado em vcpkg.json!"
            exit 1
          }
          Write-Host "Usando baseline: $baseline"
          
          git clone https://github.com/microsoft/vcpkg.git vcpkg
          cd vcpkg
          git checkout $baseline

      - name: Instalar pacotes via vcpkg
        run: |
          ./vcpkg/bootstrap-vcpkg.bat
          ./vcpkg/vcpkg install --triplet x64-windows

      - name: Compilar com CMake Presets
        uses: lukka/run-cmake@v10
        with:
          configurePreset: 'ninja-vcpkg'
          buildPreset: 'ninja-vcpkg'
          configurePresetAdditionalArgs: -DCMAKE_BUILD_TYPE=Release

      - name: Preparar Artefatos (EXE + DLLs)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "artifacts"
          $buildDir = "build"

          Write-Host "--- Procurando tfs.exe ---"
          $exe = Get-ChildItem -Path $buildDir -Filter "tfs.exe" -Recurse | Select-Object -First 1
          if ($exe) {
            Copy-Item $exe.FullName -Destination "artifacts/"
          } else {
            Write-Error "tfs.exe não encontrado!"
            exit 1
          }

          Write-Host "--- Copiando DLLs ---"
          $dlls = Get-ChildItem -Path $buildDir -Filter "*.dll" -Recurse
          foreach ($dll in $dlls) {
            if ($dll.DirectoryName -notmatch "CMakeFiles" -and $dll.DirectoryName -notmatch "test") {
              Copy-Item $dll.FullName -Destination "artifacts/" -Force
            }
          }

          if (Test-Path "config.lua") {
            Copy-Item "config.lua" -Destination "artifacts/"
          }

      - name: Upload do Artefato
        uses: actions/upload-artifact@v4
        with:
          name: tfs-windows-ninja
          path: artifacts/*
